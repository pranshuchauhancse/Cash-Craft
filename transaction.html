<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add/Edit Transaction - Cash Craft</title>
    <link rel="stylesheet" href="modal-styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="modal-overlay" id="transactionModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Transaction</h2>
                <button class="close-btn" id="closeModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="transactionForm" class="modal-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="transactionType">Transaction Type *</label>
                        <select id="transactionType" required>
                            <option value="">Select Type</option>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="transactionAmount">Amount *</label>
                        <input type="number" id="transactionAmount" placeholder="0.00" step="0.01" min="0" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="transactionCategory">Category *</label>
                        <select id="transactionCategory" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="transactionDate">Date *</label>
                        <input type="date" id="transactionDate" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="transactionDescription">Description</label>
                    <textarea id="transactionDescription" rows="3" placeholder="Add a note or description (optional)"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="transactionTags">Tags</label>
                    <input type="text" id="transactionTags" placeholder="Add tags separated by commas (optional)">
                    <small>Example: food, restaurant, lunch</small>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn-primary" id="saveBtn">Save Transaction</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        class TransactionModal {
            constructor() {
                this.currentTransaction = null;
                this.categories = {
                    income: ['Salary', 'Freelance', 'Business', 'Investment', 'Gift', 'Bonus', 'Rental', 'Other'],
                    expense: ['Food', 'Rent', 'Transport', 'Shopping', 'Entertainment', 'Healthcare', 'Education', 'Utilities', 'Insurance', 'Travel', 'Other']
                };
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.setCurrentDate();
            }

            setupEventListeners() {
                // Close modal events
                document.getElementById('closeModal').addEventListener('click', () => this.closeModal());
                document.getElementById('cancelBtn').addEventListener('click', () => this.closeModal());
                
                // Click outside to close
                document.getElementById('transactionModal').addEventListener('click', (e) => {
                    if (e.target.id === 'transactionModal') {
                        this.closeModal();
                    }
                });

                // Type change handler
                document.getElementById('transactionType').addEventListener('change', () => {
                    this.updateCategories();
                });

                // Form submission
                document.getElementById('transactionForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleSubmit();
                });

                // Listen for messages from parent window
                window.addEventListener('message', (event) => {
                    if (event.data.type === 'openTransactionModal') {
                        this.openModal(event.data.transaction);
                    }
                });
            }

            setCurrentDate() {
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('transactionDate').value = today;
            }

            updateCategories() {
                const type = document.getElementById('transactionType').value;
                const categorySelect = document.getElementById('transactionCategory');
                
                categorySelect.innerHTML = '<option value="">Select Category</option>';
                
                if (type && this.categories[type]) {
                    this.categories[type].forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categorySelect.appendChild(option);
                    });
                }
            }

            openModal(transaction = null) {
                this.currentTransaction = transaction;
                
                if (transaction) {
                    // Edit mode
                    document.getElementById('modalTitle').textContent = 'Edit Transaction';
                    document.getElementById('saveBtn').textContent = 'Update Transaction';
                    this.populateForm(transaction);
                } else {
                    // Add mode
                    document.getElementById('modalTitle').textContent = 'Add Transaction';
                    document.getElementById('saveBtn').textContent = 'Save Transaction';
                    this.resetForm();
                }
                
                document.getElementById('transactionModal').style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            closeModal() {
                document.getElementById('transactionModal').style.display = 'none';
                document.body.style.overflow = 'auto';
                this.resetForm();
                this.currentTransaction = null;
            }

            populateForm(transaction) {
                document.getElementById('transactionType').value = transaction.type;
                this.updateCategories();
                
                setTimeout(() => {
                    document.getElementById('transactionCategory').value = transaction.category;
                }, 100);
                
                document.getElementById('transactionAmount').value = transaction.amount;
                document.getElementById('transactionDate').value = transaction.date;
                document.getElementById('transactionDescription').value = transaction.description || '';
                document.getElementById('transactionTags').value = transaction.tags ? transaction.tags.join(', ') : '';
            }

            resetForm() {
                document.getElementById('transactionForm').reset();
                this.setCurrentDate();
                this.updateCategories();
            }

            handleSubmit() {
                const formData = this.getFormData();
                
                if (!this.validateForm(formData)) {
                    return;
                }

                // Send data back to parent window
                const message = {
                    type: 'transactionSubmit',
                    data: {
                        ...formData,
                        id: this.currentTransaction ? this.currentTransaction.id : Date.now(),
                        isEdit: !!this.currentTransaction
                    }
                };

                if (window.parent && window.parent !== window) {
                    window.parent.postMessage(message, '*');
                } else {
                    // If not in iframe, handle locally (for standalone testing)
                    console.log('Transaction data:', message.data);
                    this.showNotification('Transaction saved successfully!', 'success');
                }

                this.closeModal();
            }

            getFormData() {
                const tags = document.getElementById('transactionTags').value
                    .split(',')
                    .map(tag => tag.trim())
                    .filter(tag => tag.length > 0);

                return {
                    type: document.getElementById('transactionType').value,
                    amount: parseFloat(document.getElementById('transactionAmount').value),
                    category: document.getElementById('transactionCategory').value,
                    date: document.getElementById('transactionDate').value,
                    description: document.getElementById('transactionDescription').value.trim(),
                    tags: tags.length > 0 ? tags : null,
                    createdAt: new Date().toISOString()
                };
            }

            validateForm(data) {
                if (!data.type) {
                    this.showNotification('Please select a transaction type', 'error');
                    return false;
                }

                if (!data.amount || data.amount <= 0) {
                    this.showNotification('Please enter a valid amount', 'error');
                    return false;
                }

                if (!data.category) {
                    this.showNotification('Please select a category', 'error');
                    return false;
                }

                if (!data.date) {
                    this.showNotification('Please select a date', 'error');
                    return false;
                }

                return true;
            }

            showNotification(message, type = 'info') {
                // Create notification element
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                notification.innerHTML = `
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                `;

                document.body.appendChild(notification);

                // Show notification
                setTimeout(() => notification.classList.add('show'), 100);

                // Hide and remove notification
                setTimeout(() => {
                    notification.classList.remove('show');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        }

        // Initialize the modal
        const transactionModal = new TransactionModal();
    </script>
</body>
</html>